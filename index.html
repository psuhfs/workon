<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Points Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Function to format the date as MM/DD/YYYY without timezone issues
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`; // MM/DD/YYYY format
        }

        let allEmployees = [];

        // Function to fetch and populate employees
        async function fetchEmployees() {
            try {
                const response = await fetch(
                    'https://www7.whentowork.com/cgi-bin/w2wG3.dll/api/EmployeeList?key=G042D1B58-7BA2233F1F3248279DCB30F1C5AE221D'
                );
                const data = await response.json();
                allEmployees = data.EmployeeList; // Store all employees globally
        
                populateDropdown(allEmployees); // Populate the dropdown initially
            } catch (error) {
                console.error('Error fetching employee data:', error);
            }
        }
        
        // Function to populate the dropdown with employees
        function populateDropdown(employees) {
            const dropdown = document.getElementById('employee-name');
            dropdown.innerHTML = '<option value="">Select an employee</option>'; // Clear previous options
        
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.textContent = `${employee.FIRST_NAME} ${employee.LAST_NAME}`;
                option.value = employee.EMPLOYEE_NUMBER;
                dropdown.appendChild(option);
            });
        }
        
        // Function to filter the dropdown based on input
        function filterEmployees() {
            const input = document.getElementById('employee-search').value.toLowerCase();
            const filteredEmployees = allEmployees.filter(employee =>
                `${employee.FIRST_NAME} ${employee.LAST_NAME}`.toLowerCase().includes(input)
            );
            populateDropdown(filteredEmployees); // Repopulate the dropdown with filtered results
        }
                
        // Function to fetch and display shifts for the selected employee and date
        async function fetchShifts() {
            const employeeId = document.getElementById('employee-name').value;
            const dateValue = document.getElementById('shift-date').value;

            if (!employeeId || !dateValue) return; // Ensure both fields are selected

            const formattedDate = formatDate(dateValue);
            const url = `https://www7.whentowork.com/cgi-bin/w2wG3.dll/api/AssignedShiftList?start_date=${formattedDate}&end_date=${formattedDate}&key=G042D1B58-7BA2233F1F3248279DCB30F1C5AE221D`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const shifts = data.AssignedShiftList || [];

                const shiftContainer = document.getElementById('shift-options');
                shiftContainer.innerHTML = ''; // Clear previous shifts

                const filteredShifts = shifts.filter(shift =>
                    shift.EMPLOYEE_NUMBER === employeeId && shift.START_DATE === formattedDate
                );

                if (filteredShifts.length > 0) {
                    filteredShifts.forEach(shift => {
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.id = shift.SHIFT_ID;
                        radio.name = 'shift';
                        radio.value = `${shift.START_TIME} - ${shift.END_TIME}`;

                        const label = document.createElement('label');
                        label.htmlFor = shift.SHIFT_ID;
                        label.textContent = `${shift.START_TIME} - ${shift.END_TIME} (${shift.POSITION_NAME})`;

                        shiftContainer.appendChild(radio);
                        shiftContainer.appendChild(label);
                        shiftContainer.appendChild(document.createElement('br'));
                    });
                } else {
                    shiftContainer.textContent = 'No shifts found. Enter shift details below:';
                }
            } catch (error) {
                console.error('Error fetching shifts:', error);
            }
        }

        // Function to handle form submission
        function handleSubmit(event) {
            event.preventDefault(); // Prevent form submission to server

            const formData = {
                accessCode: document.getElementById('access-code').value,
                employeeName: document.getElementById('employee-name').selectedOptions[0].text,
                employeeId: document.getElementById('employee-name').value,
                shiftDate: document.getElementById('shift-date').value,
                selectedShift: document.querySelector('input[name="shift"]:checked')?.value || '',
                manualShift: document.getElementById('manual-shift').value,
                reason: document.querySelector('input[name="reason"]:checked')?.value || '',
                comments: document.getElementById('comments').value,
            };

            console.log('Form Data:', formData); // Print form data to console
        }

        function selectReason(reason) {
            // Set the value of the hidden input
            document.getElementById('reason').value = reason;
        
            // Clear previous selections
            document.querySelectorAll('.reason-button').forEach(button => {
                button.classList.remove('selected');
            });
        
            // Highlight the selected button
            const selectedButton = Array.from(document.querySelectorAll('.reason-button')).find(
                button => button.textContent === reason
            );
            if (selectedButton) selectedButton.classList.add('selected');
        }        

        window.onload = fetchEmployees;
    </script>
</head>

<body>
    <header>
        <h1>Points Tracker</h1><br </header>

        <main>
            <form id="points-form" action="#" method="POST" onsubmit="handleSubmit(event)">
                <label for="access-code">Access Code:</label>
                <input type="password" id="access-code" name="access-code" required>

                <label for="employee-search">Search Employee:</label>
                <input type="text" id="employee-search" placeholder="Start typing an employee name..." oninput="filterEmployees()">
                
                <select id="employee-name" name="employee-name" onchange="fetchShifts()" required title="Employee Name">
                    <option value="">Select an employee</option>
                </select>
                
                <label for="shift-date">Select Date:</label>
                <input type="date" id="shift-date" name="shift-date" onchange="fetchShifts()" required>

                <div id="shift-options" class="shift-container">
                    <p>Select a shift or enter details manually below:</p>
                </div>

                <label for="manual-shift">Manual Shift Entry (if needed):</label>
                <input type="text" id="manual-shift" name="manual-shift" placeholder="E.g., 9:00 AM - 5:00 PM">

                <legend>Reason for Points:</legend>
                <br>
                <div class="button-group">
                    <button type="button" class="reason-button" onclick="selectReason('Tardy')">Tardy</button>
                    <button type="button" class="reason-button" onclick="selectReason('Uniform & Grooming Standards')">Uniform & Grooming Standards</button>
                    <button type="button" class="reason-button" onclick="selectReason('NCNS')">NCNS</button>
                    <button type="button" class="reason-button" onclick="selectReason('Unexcused Absence')">Unexcused Absence</button>
                    <button type="button" class="reason-button" onclick="selectReason('Excused Absence')">Excused Absence</button>
                    <button type="button" class="reason-button" onclick="selectReason('No ID')">No ID</button>
                    <button type="button" class="reason-button" onclick="selectReason('Safety Issue')">Safety Issue</button>
                    <button type="button" class="reason-button" onclick="selectReason('Other')">Other</button>
                </div>
                
                <!-- Hidden input to store the selected reason -->
                <input type="hidden" id="reason" name="reason" required>
                               
                
                <label for="comments">Comments:</label>
                <textarea id="comments" name="comments" rows="4" placeholder="Enter additional comments"></textarea>

                <button type="submit">Submit</button>
            </form>
        </main>
</body>

</html>